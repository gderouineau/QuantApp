{% extends "base_admin.html" %}

{% block head_title %}{{ object|default_if_none:"Nouvelle" }} stratégie — Admin{% endblock %}

{% block breadcrumbs %}
<li><a href="{% url 'strategies:custom_list' %}">Stratégies</a></li>
<li>Custom</li>
<li>{{ object.name|default_if_none:"Nouvelle" }}</li>
{% endblock %}

{% block page_actions %}
<a class="btn" href="{% url 'strategies:custom_list' %}">← Retour</a>
{% endblock %}

{% block content %}
<div class="card">
    <form method="post" novalidate>
        {% csrf_token %}
        {% if form.non_field_errors %}
            <div class="msg error">{{ form.non_field_errors }}</div>
        {% endif %}

        <div class="grid grid-2">
            <div class="form-group">
                <label for="{{ form.name.id_for_label }}">Nom</label>
                {{ form.name }}
                {{ form.name.errors }}
            </div>

            <div class="form-group">
                <label for="{{ form.weight.id_for_label }}">Poids</label>
                {{ form.weight }}
                {{ form.weight.errors }}
            </div>

            <div class="form-group">
                <label for="{{ form.is_active.id_for_label }}">Active</label>
                {{ form.is_active }}
                {{ form.is_active.errors }}
            </div>

            <div class="form-group" style="grid-column: 1 / -1;">
                <label for="id_parameters_text">Paramètres (JSON)</label>
                {{ form.parameters_text }}
                <div class="help">{{ form.fields.parameters_text.help_text }}</div>
                {{ form.parameters_text.errors }}
            </div>

            <!-- NOUVEAU : Plan d’optimisation -->
            <div class="form-group" style="grid-column: 1 / -1;">
                <label for="id_optimize_parameters_text">Plan d’optimisation (JSON)</label>
                {{ form.optimize_parameters_text }}
                <div class="help">{{ form.fields.optimize_parameters_text.help_text }}</div>
                {{ form.optimize_parameters_text.errors }}
            </div>

            <div class="form-group" style="grid-column: 1 / -1;">
                <label for="{{ form.code.id_for_label }}">Code Python</label>
                {{ form.code }}
                <div class="help">{{ form.fields.code.help_text }}</div>
                {{ form.code.errors }}
            </div>
        </div>

        <div class="form-actions">
            <button class="btn primary" type="submit">Enregistrer</button>
            {% if object %}
                <a class="btn" href="{% url 'strategies:custom_list' %}">Annuler</a>
            {% endif %}
        </div>
    </form>
</div>

{% if object %}
<div class="card">
    <h3>Tester cette stratégie</h3>
    <div class="inline-form" hx-target="#test-output" hx-swap="innerHTML">
        <input type="text" class="input" name="symbol" placeholder="AAPL, AIR.PA …">
        <button class="btn" hx-get="{% url 'strategies:custom_test' object.id %}" hx-include="closest .inline-form">Tester</button>
    </div>
    <div id="test-output" class="mono small muted" style="max-height:320px; overflow:auto; margin-top:8px;"></div>
</div>
{% endif %}
{% endblock %}
